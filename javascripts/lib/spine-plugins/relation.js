(function(){var a,b,c,d,e,f,g={}.hasOwnProperty,h=function(a,b){function d(){this.constructor=a}for(var c in b)g.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};d=Spine.isArray,a=function(a){function b(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c}return h(b,a),b.name="Collection",b.prototype.all=function(){var a=this;return this.model.select(function(b){return a.associated(b)})},b.prototype.first=function(){return this.all()[0]},b.prototype.last=function(){var a;return a=this.all(),a[a.length-1]},b.prototype.find=function(a){var b,c=this;b=this.select(function(b){return b.id+""==a+""});if(!b[0])throw"Unknown record";return b[0]},b.prototype.findAllByAttribute=function(a,b){var c=this;return this.model.select(function(c){return c[a]===b})},b.prototype.findByAttribute=function(a,b){return this.findAllByAttribute(a,b)[0]},b.prototype.select=function(a){var b=this;return this.model.select(function(c){return b.associated(c)&&a(c)})},b.prototype.refresh=function(a){var b,c,e,f,g,h,i;i=this.all();for(e=0,g=i.length;e<g;e++)b=i[e],delete this.model.records[b.id];c=this.model.fromJSON(a),d(c)||(c=[c]);for(f=0,h=c.length;f<h;f++)b=c[f],b.newRecord=!1,b[this.fkey]=this.record.id,this.model.records[b.id]=b;return this.model.trigger("refresh",c)},b.prototype.create=function(a){return a[this.fkey]=this.record.id,this.model.create(a)},b.prototype.associated=function(a){return a[this.fkey]===this.record.id},b}(Spine.Module),b=function(a){function b(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c}return h(b,a),b.name="Instance",b.prototype.exists=function(){return this.record[this.fkey]&&this.model.exists(this.record[this.fkey])},b.prototype.update=function(a){return a instanceof this.model||(a=new this.model(a)),a.isNew()&&a.save(),this.record[this.fkey]=a&&a.id},b}(Spine.Module),c=function(a){function b(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c}return h(b,a),b.name="Singleton",b.prototype.find=function(){return this.record.id&&this.model.findByAttribute(this.fkey,this.record.id)},b.prototype.update=function(a){return a instanceof this.model||(a=this.model.fromJSON(a)),a[this.fkey]=this.record.id,a.save()},b}(Spine.Module),e=function(a){return a.replace(/s$/,"")},f=function(a){return a.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/-/g,"_").toLowerCase()},Spine.Model.extend({hasMany:function(b,c,d){var e;return d==null&&(d=""+f(this.className)+"_id"),e=function(e){return typeof c=="string"&&(c=require(c)),new a({name:b,model:c,record:e,fkey:d})},this.prototype[b]=function(a){return a!=null&&e(this).refresh(a),e(this)}},belongsTo:function(a,c,d){var f;return d==null&&(d=""+e(a)+"_id"),f=function(e){return typeof c=="string"&&(c=require(c)),new b({name:a,model:c,record:e,fkey:d})},this.prototype[a]=function(a){return a!=null&&f(this).update(a),f(this).exists()},this.attributes.push(d)},hasOne:function(a,b,d){var e;return d==null&&(d=""+f(this.className)+"_id"),e=function(e){return typeof b=="string"&&(b=require(b)),new c({name:a,model:b,record:e,fkey:d})},this.prototype[a]=function(a){return a!=null&&e(this).update(a),e(this).find()}}})}).call(this);